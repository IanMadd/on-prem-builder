<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Chef Habitat Builder on-prem</title>
<link rel="shortcut icon" type="image/png" href="/images/favicon.ico" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />

  <link rel="stylesheet" href="/css/chef-sh.css" />
</head>

<body>
  <div class="off-canvas-wrapper has-sidebar">
    <div class="off-canvas-content" data-off-canvas-content>
      <div class="cell small-12">
        <nav id="utility-bar" class="utility-bar" data-toggler="active">
  <div class="grid-container">
    <div class="grid-x align-right">
      <div class="cell medium-7 utility-bar-wrapper text-right">
        <button type="button" class="utility-bar-button" data-toggle="utility-bar">
          <span class="show-for-medium">Explore the <span class="chef-logo"><span class="sr-only">Chef</span></span> Automation Portfolio</span>
          <span class="show-for-small-only">Chef Automation</span>
          <span class="arrow"><span class="sr-only">Expand</span></span>
        </button>
        <div class="utility-bar-content text-left">
          <div class="grid-x">
            <div class="oss-projects grid-x" data-equalizer>
              <div class="cell medium-4">
                <a href="https://chef.sh">
                  <div data-equalizer-watch><img src="/images/chef-logo.svg" alt="Chef" width="131" class="chef"></div>
                  <p>Ensure configurations are applied consistently in every environment, at any scale.</p>
                </a>
              </div>
              <div class="cell medium-4">
                <a href="https://inspec.io">
                  <div data-equalizer-watch><img src="/images/inspec-logo.svg" alt="Inspec" width="133" class="inspec"></div>
                  <p>Automate the validation of compliance and security in any environment, on any platform.</p>
                </a>
              </div>
              <div class="cell medium-4">
                <a href="https://habitat.sh">
                  <div data-equalizer-watch><img src="/images/habitat-logo.svg" alt="Habitat" width="111" class="habitat"></div>
                  <p>Automate the process of building, deploying, and managing any application in any environment.</p>
                </a>
              </div>
            </div>
            <div class="automate cell small-12">
              <div class="cell small-12">
                <a href="https://automate.chef.io" class="with-arrow-button">
                  <img src="/images/chef-automate-logo.svg" alt="Chef Automate" width="217" class="chef-automate">
                  <p>Build, deploy, and manage faster, more efficiently, and with less risk with Chef Automate, the continuous automation platform.</p>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</nav>

      </div>
      <div id="menu" class="cell small-12" data-sticky-container>
        

<nav data-sticky class="sticky" style="min-width:100%;" data-check-every="0" data-sticky-on="small" data-margin-top="0" data-top-anchor="utility-bar:bottom">
  <header>
    <div class="grid-container">
      <div class="grid-x">
        <div id="header-logo" class="cell large-3 small-11">
          <a href="/"><img src="/images/chef-logo.svg" alt="Chef Habitat Builder on-prem documentation"></a>
        </div>
        <div id="header-toggle" data-responsive-toggle="header-menu" data-hide-for="large" class="cell small-1">
          <div class="valign-small">
            <button type="button" data-toggle="header-menu" aria-label="Menu"><i aria-hidden="true" class="fas fa-bars fa-lg"></i></button>
          </div>
        </div>
        <div id="header-menu" class="cell large-9 small-12">
          <ul class="vertical medium-horizontal menu">
            
          </ul>
        </div>

      </div>
    </div>
  </header>
</nav>

      </div>
      <div id="main-content" class="cell small-12" data-sticky-container>
        <div class="grid-container">
          <div class="grid-x">
            <div class="cell medium-3 col-sidebar">
              


<aside class="sticky" data-sticky data-anchor="main-content-col" data-margin-top="4" data-margin-bottom="2">
  <nav id="sidebar-nav">
    
    
    <div class="nav">
      <ul class="vertical menu accordion-menu" data-accordion-menu>
        
      </ul>
    </div>
  </nav>
</aside>

            </div>
            <div id="main-content-col" class="cell medium-9 col-content">
              
<h1>Chef Habitat Builder on-prem</h1>
<div class="prose">
  

<h1 id="chef-habitat-builder-on-prem">Chef Habitat Builder on-prem</h1>

<p><strong>Umbrella Project</strong>: <a href="https://github.com/habitat-sh/habitat">Chef Habitat</a></p>

<p><strong>Project State</strong>: <a href="https://github.com/chef/chef-oss-practices/blob/master/repo-management/repo-states.md#active">Active</a></p>

<p><strong>Issues Response SLA</strong>: 5 business days</p>

<p><strong>Pull Request Response SLA</strong>: 5 business days</p>

<h2 id="important-notice">IMPORTANT NOTICE</h2>

<p>Please see the <a href="minio-migration.md">Migrating Package Artifacts to Minio</a> if your existing Chef Habitat Builder on-prem was installed <em>prior</em> to June 15th 2018. The package artifacts are now stored in a Minio instance, and running a migration script will be required in order to properly transition over to newer versions of Chef Habitat Builder on-prem.</p>

<p>Please see the <a href="postgres.md#merging-database-shards">Merging database shards</a> section if
your existing Chef Habitat Builder on-prem was installed <em>prior</em> to August 17th 2018. All
of the database schemas and data are now stored in the Postgres <code>public</code>
schema, instead of spread across various shard schemas.</p>

<p>Please see the <a href="postgres.md#merging-databases">Merging databases</a> section if
your existing Chef Habitat Builder on-prem was installed <em>prior</em> to September 24th 2018. All
data is now stored in a single Postgres database <code>builder</code> instead of spread across
multiple databases.</p>

<h2 id="introduction">Introduction</h2>

<p>This repository contains scripts to install Chef Habitat Builder on-prem services. These services (referred to as the Chef Habitat Builder on-prem) allow privately hosting Chef Habitat packages (and associated artifacts such as keys) on-premise. Chef Habitat clients (such as the <code>hab</code> cli, Supervisors and Studios) can be pointed to the Chef Habitat Builder on-prem and allow for development, execution and management without depending on the public Chef Habitat services.</p>

<h2 id="audience">Audience</h2>

<p>This repository is intended for use by any one who wishes to host Chef Habitat packages in their own infrastructure. Users should be prepared to actively update their installations to benefit from continued improvements and updates.</p>

<h2 id="requirements">Requirements</h2>

<p>The following are minimum requirements for installation/deployment of the Chef Habitat Builder on-prem:</p>

<ul>
<li>Services should be deployed on a Chef Habitat supported <a href="https://www.habitat.sh/docs/install-habitat/">Linux OS</a></li>
<li>OS should support <code>systemd</code> process manager</li>
<li>Deployment to bare-metal, VM or container image</li>
<li>CPU / RAM should be appropriate for the deployment purpose:

<ul>
<li>2 CPU/4 GB RAM for trial deployments</li>
<li>16 CPU/32 GB RAM for production deployments</li>
</ul></li>
<li>Significant free disk space

<ul>
<li>2GB for the baseline Chef Habitat Builder on-prem services</li>
<li>15GB+ for the latest Chef Habitat Builder core packages</li>
<li>30GB+ for downloading and expanding the core package bootstrap in the volume containing the <code>/tmp</code> directory</li>
</ul></li>
<li>We recommend:

<ul>
<li>20 GB disk space for trial deployments</li>
<li>100 GB disk space for production deployments</li>
</ul></li>
<li>Deploy services single-node - scale out is not yet supported</li>
<li>Outbound network (HTTPS) connectivity to WAN is required for the <em>initial</em> install</li>
<li>Inbound network connectivity from LAN (HTTP/HTTPS) is required for internal clients to access the Chef Habitat Builder on-prem</li>
<li>OAuth2 authentication provider (Chef Automate v2, Azure AD, GitHub, GitHub Enterprise, GitLab, Okta and Bitbucket (cloud) have been verified - additional providers may be added on request)</li>
</ul>

<h2 id="functionality">Functionality</h2>

<p>Once installed, the following functionality will be available to users:</p>

<ul>
<li>Logging into the Chef Habitat Builder on-prem web site</li>
<li>Creation of origins, keys, access tokens, etc</li>
<li>Invitation of users to origins</li>
<li>Upload and download of Chef Habitat packages</li>
<li>Promotion and demotion of Chef Habitat packages to channels</li>
<li>Normal interactions of the <code>hab</code> client with the Chef Habitat Builder API</li>
<li>Package builds using the <code>hab</code> client and Chef Habitat Studio</li>
<li>Ability to import core packages from the upstream Chef Habitat Builder</li>
</ul>

<p>The following Chef Habitat Builder on-prem functionalities are <em>NOT</em> currently available:</p>

<ul>
<li>Automated package builds using Chef Habitat Builder on-prem</li>
<li>Automated package exports using Chef Habitat Builder on-prem</li>
</ul>

<h2 id="pre-requisites">Pre-Requisites</h2>

<p>Prior to starting the install, please ensure you have reviewed all the items
in the Requirements section, and have a location for the installation that
meets all the requirements.</p>

<p>Note that the initial install will require <em>outgoing</em> network connectivity.</p>

<p>Your Chef Habitat Builder on-prem instance will need to have the following <em>inbound</em> port open:</p>

<ul>
<li>Port 80 (or 443 if you plan to enable SSL)</li>
</ul>

<p>You may need to work with your enterprise network admin to enable the appropriate firewall rules.</p>

<h3 id="oauth-application">OAuth Application</h3>

<p>We currently support Chef Automate v2, Azure AD (OpenId Connect), GitHub, GitLab (OpenId Connect), Okta (OpenId Connect) and Atlassian Bitbucket (cloud) OAuth providers for authentication. You will need to set up an OAuth application for the instance of the Chef Habitat Builder on-prem you are setting up.</p>

<p>Refer to the steps that are specific to your OAuth provider to create and configure your OAuth application. The below steps illustrate setting up the OAuth application using Github as the identity provider:</p>

<ol>
<li>Create a new OAuth Application in your OAuth Provider - for example, <a href="https://github.com/settings/applications/new">GitHub</a></li>
<li>Set the homepage url value of <code>APP_URL</code> to <code>http://${BUILDER_HOSTNAME_OR_IP}/</code>, or <code>https://${BUILDER_HOSTNAME_OR_IP}/</code> if you plan to enable SSL.</li>
<li>Set the callback url value of <code>OAUTH_REDIRECT_URL</code> to <code>http://${BUILDER_HOSTNAME_OR_IP}/</code> (The trailing <code>/</code> is <em>important</em>). Specify <code>https</code> instead of <code>http</code> if you plan to enable SSL.</li>
<li>Record the the Client Id and Client Secret. These will be used for the <code>OAUTH_CLIENT_ID</code> and <code>OAUTH_CLIENT_SECRET</code> environment variables in the section below.</li>
</ol>

<p>For the configuration below, you will also need to know following <em>fully qualified</em> end-points:</p>

<ul>
<li>Authorization Endpoint (example: <code>https://github.com/login/oauth/authorize</code>)</li>
<li>Token Endpoint (example: <code>https://github.com/login/oauth/access_token</code>)</li>
<li>API Endpoint (example: <code>https://api.github.com/user</code>)</li>
</ul>

<p>For more information, please refer to the developer documentation of these services:</p>

<ul>
<li><a href="https://automate.chef.io/docs/configuration/#alpha-setting-up-automate-as-an-oauth-provider-for-habitat-builder">Chef Automate (ALPHA)</a></li>
<li><a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-protocols-oauth-code">Azure Active Directory</a></li>
<li><a href="https://developer.github.com/apps/building-oauth-apps/authorization-options-for-oauth-apps/">GitHub</a></li>
<li><a href="https://docs.gitlab.com/ee/integration/oauth_provider.html">GitLab</a></li>
<li><a href="https://developer.okta.com/authentication-guide/implementing-authentication/auth-code">Okta</a></li>
<li><a href="https://confluence.atlassian.com/bitbucket/oauth-on-bitbucket-cloud-238027431.html">BitBucket</a></li>
</ul>

<p>For further information on OAuth endpoints, see the Internet Engineering Task Force (IETF) RFC 6749, <a href="https://tools.ietf.org/html/rfc6749">The OAuth 2.0 Authorization Framework</a>, page 21.</p>

<h3 id="preparing-your-filesystem-optional">Preparing your filesystem (Optional)</h3>

<p>Since substantial storage may be required for holding packages, please ensure you have an appropriate amount of free space on your filesystem.</p>

<p>The package artifacts will be stored in your Minio instance by default, typically at the following location: <code>/hab/svc/builder-minio/data</code></p>

<p>If you need to add additional storage, it is recommended that you create a mount at <code>/hab</code> and point it to your external storage. This is not required if you already have sufficient free space.</p>

<p><em>Note</em>: If you would prefer to Artifactory instead of Minio for the object storage, please see the <a href="artifactory.md">Artifactory</a> documentation.</p>

<h3 id="procuring-ssl-certificate-recommended">Procuring SSL certificate (Recommended)</h3>

<p>By default, the Chef Habitat Builder on-prem will expose the web UI and API via http. Though it allows for easier setup and is fine for evaluation purposes, for a secure and more permanent installation it is recommended that you enable SSL on the Chef Habitat Builder endpoints.</p>

<p>In order to prepare for this, you should procure a SSL certificate. If needed, you may use a self-signed certificate - however if you do so, you will need to install the certificate in the trusted chain on client machines (ones that will use the Chef Habitat Builder UI or APIs). You may use the <code>SSL_CERT_FILE</code> environment variable to also point to the certificate on client machines when invoking the <code>hab</code> client, for example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#b8860b">SSL_CERT_FILE</span><span style="color:#666">=</span>ssl-certificate.crt hab pkg search -u https://localhost &lt;search term&gt;</code></pre></div>
<p>Below is a sample command to generate a self-signed certificate with OpenSSL:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo openssl req -x509 -nodes -days <span style="color:#666">365</span> -newkey rsa:2048 -keyout /etc/ssl/private/ssl-certificate.key -out /etc/ssl/certs/ssl-certificate.crt</code></pre></div>
<p><em>Important</em>: Make sure that the certificate files are named exactly <code>ssl-certificate.key</code> and <code>ssl-certificate.crt</code>. If you have procured the certificate from a different source, rename them to the prescribed filenames, and ensure that they are located in the same folder as the <code>install.sh</code> script. They will get uploaded to the Chef Habitat supervisor during the install.</p>

<h2 id="setup">Setup</h2>

<ol>
<li>Clone this repo (or unzip the archive you have downloaded from the Github release page) at the desired machine where you will stand up the Chef Habitat Builder on-prem</li>
<li><code>cd ${SRC_ROOT}</code></li>
<li><code>cp bldr.env.sample bldr.env</code></li>
<li>Edit <code>bldr.env</code> with a text editor and replace the values appropriately. Consider helping us to improve Chef Habitat as well by changing the <code>ANALYTICS_ENABLED</code> setting to <code>true</code> and providing an optional company name.</li>
<li><code>./install.sh</code></li>
</ol>

<p>If everything goes well, you should see output similar to the following showing that the Chef Habitat Builder on-prem services are loaded:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-output" data-lang="output">hab-sup(MN): The habitat/builder-datastore service was successfully loaded
hab-sup(MN): The habitat/builder-router service was successfully loaded
hab-sup(MN): The habitat/builder-api service was successfully loaded
hab-sup(MN): The habitat/builder-api-proxy service was successfully loaded
hab-sup(MN): The habitat/builder-originsrv service was successfully loaded
hab-sup(MN): The habitat/builder-sessionsrv service was successfully loaded</code></pre></div>
<p>Do a <code>hab svc status</code> to check the status of all the services. They may take a few seconds to all come up.</p>

<p>If things don&rsquo;t work as expected (eg, if all the services are not in the <code>up</code> state), please see the Troubleshooting section below.</p>

<h2 id="minio-web-ui">Minio Web UI</h2>

<p>The Chef Habitat Builder on-prem stores package artifacts in <a href="https://github.com/minio/minio">Minio</a>. By default, the Minio instance will be available on port 9000 (or whatever port you specified in your <code>bldr.env</code>). Please confirm that the Minio UI is available, and that you can log in with the credentials that were specified in your <code>bldr.env</code> file. There should already be a bucket created in which to host the artifacts.</p>

<h2 id="chef-habitat-builder-on-prem-web-ui">Chef Habitat Builder on-prem Web UI</h2>

<p>Once the services are running successfully, the Chef Habitat Builder on-prem UI will become available at the configured hostname or IP address.</p>

<p>Navigate to <code>http://${BUILDER_HOSTNAME_OR_IP}/#/sign-in</code> to access the Chef Habitat Builder on-prem UI.</p>

<p>At that point you should be able to log in using your configured OAuth provider.</p>

<h3 id="create-an-origin">Create an Origin</h3>

<p>Create a <code>core</code> origin for an initial set of base packages. Uploads will fail unless you first populate your Chef Habitat Builder on-prem with the upstream <code>core</code> upstream origin.</p>

<p>Once you are logged in to the Chef Habitat Builder on-prem UI, select the <code>New Origin</code> button and enter in <code>core</code> as the origin name.</p>

<h3 id="generate-a-personal-access-token">Generate a Personal Access Token</h3>

<p>Next, generate a Personal Access Token for bootstrapping the <code>core</code> packages, as well as for performing authenticated operations using the <code>hab</code> client.</p>

<p>Select your Gravatar icon on the top right corner of the Chef Habitat Builder on-prem web page, and then select <strong>Profile</strong>. This will take you to a page where you can generate your access token. Make sure to save it securely.</p>

<h2 id="bootstrap-core-packages">Bootstrap <code>core</code> packages</h2>

<p><em>Important</em>: Create a <code>core</code> origin before starting this process. The process will fail without first having a <code>core</code> origin.</p>

<p>Chef Habitat Builder on-prem has no pre-installed packages. To bootstrap a set of stable <code>core</code> origin packages (refer to the <a href="https://github.com/habitat-sh/core-plans">core-plans repo</a>), you can do the following:</p>

<ol>
<li><p>Export your Personal Access Token as <code>HAB_AUTH_TOKEN</code> to your environment</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#a2f">export</span> <span style="color:#b8860b">HAB_AUTH_TOKEN</span><span style="color:#666">=</span>&lt;your token&gt;</code></pre></div></li>

<li><p>Run the population script, passing the root URL of your new Chef Habitat Builder on-prem as the last argument (Replace <code>http</code> with <code>https</code> in the URL if SSL is enabled)</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo -E ./scripts/on-prem-archive.sh populate-depot http://<span style="color:#b68;font-weight:bold">${</span><span style="color:#b8860b">BUILDER_HOSTNAME_OR_IP</span><span style="color:#b68;font-weight:bold">}</span><span style="color:#b44">`</span></code></pre></div></li>
</ol>

<p>This is quite a lengthy process, so be patient. It will download a <em>large</em> (~ 14GB currently) archive of the latest stable core plans, and then install them to your Chef Habitat Builder on-prem.</p>

<p>Please ensure that you have plenty of free disk space available for hosting the <code>core</code> packages as well as for managing your own packages. Updated packages install without deleting any existing packages, so plan disk space accordingly.</p>

<h2 id="synchronizing-core-packages-from-an-upstream">Synchronizing &lsquo;core&rsquo; packages from an upstream</h2>

<p><em>Important</em>: Create a <code>core</code> origin before starting this process. The process will fail without first having a <code>core</code> origin.</p>

<p>It is possible to also use the &lsquo;on-prem-archive.sh&rsquo; script to synchronize the Chef Habitat Builder on-prem using the public Chef Habitat Builder site as an &lsquo;upstream&rsquo;.</p>

<p>This allows new stable core packages from the upstream to get created in the Chef Habitat Builder on-prem instance automatically.</p>

<p>If your Chef Habitat Builder on-prem instance will have continued outgoing internet connectivity, you may wish to periodically run the script to check for updates.</p>

<ol>
<li>Export your Personal Access Token as <code>HAB_AUTH_TOKEN</code> to your environment (e.g, <code>export HAB_AUTH_TOKEN=&lt;your token&gt;</code>)</li>
<li><code>sudo -E ./scripts/on-prem-archive.sh sync-packages http://${BUILDER_HOSTNAME_OR_IP} base-plans</code>, passing the root URL of your new Chef Habitat Builder on-prem as the last argument. Replace <code>http</code> with <code>https</code> in the URL if SSL is enabled.</li>
</ol>

<p>The &lsquo;base-plans&rsquo; parameter restricts the sync to a smaller subset of the core packages. If you wish to synchronize all core packages, omit the &lsquo;base-plans&rsquo; parameter from the script. Note that it will take much longer for the synchronization of all packages. Generally, it will only take a few minutes for base packages to synchronize.</p>

<p>You can also run the sync-packages functionality to initially populate the local Chef Habitat Builder on-prem.</p>

<p><em>NOTE</em>: This functionality is being provided as an alpha - please log any issues found in the on-prem-builder repo.</p>

<h2 id="configuring-a-user-workstation">Configuring a user workstation</h2>

<p>Configuring a user&rsquo;s workstation to point to the Chef Habitat Builder on-prem should be fairly straightforward.</p>

<p>The following environment variables should be configured as needed:</p>

<ol>
<li><code>HAB_BLDR_URL</code> - this is the main (and most important) configuration. It should point to the instance of Chef Habitat Builder on-prem that you have set up.</li>
<li><code>HAB_AUTH_TOKEN</code> - this is the user&rsquo;s auth token that will be needed for private packages (if any), or for operations requiring privileges, for example, package uploads. The user will need to create their auth token and set/use it appropriately.</li>
<li><code>SSL_CERT_FILE</code> - if the Chef Habitat Builder on-prem is configured with SSL and uses a self-signed or other certificate that is not in the trusted chain, then this environment variable can be used on the user&rsquo;s workstation to point the <code>hab</code> client to the correct certificate to use when connecting to Chef Habitat Builder on-prem.</li>
</ol>

<h2 id="upgrading">Upgrading</h2>

<p>Currently, Chef Habitat Builder on-prem services are not set to auto-upgrade. When you wish to upgrade the services, there is a simple uninstall script you can use to stop and unload the services, and remove the services. In order to uninstall, you may do the following:</p>

<ol>
<li><code>cd ${SRC_ROOT}</code></li>
<li><code>sudo ./uninstall.sh</code></li>
</ol>

<p>Once the services are uninstalled, you may re-install them by running <code>./install.sh</code> again.</p>

<p><em>IMPORTANT</em>: Running the uninstall script will <em>NOT</em> remove any user data, so you can freely uninstall and re-install the services.</p>

<h3 id="backing-up-builder-data">Backing up Builder Data</h3>

<p>The data that Builder stores is luckily fairly lightweight and thus the backup and DR strategy is pretty straightforward. With On-Prem Builder we have two types of data that a user may want to restore in the case of a disaster. First, the package and user metadata, which gets stored in a PostgreSQL instance and second, habitat artifacts (.harts) which get stored in whichever artifact storage backend you&rsquo;ve chosen to use (Minio, S3, Artifactory).</p>

<p>Ideally backups of the Builder cluster would be performed in lock-step however, due to the nature of the data that Builder stores there is very little concern with the timing of this operation. In the worst case if a package&rsquo;s metadata is missing from PostgreSQL, it can easily be repopulated by re-uploading the package with the <code>--force</code> flag like so <code>hab pkg upload &lt;path to hartfile&gt; -u &lt;on-prem_url&gt; --force</code></p>

<h4 id="database-backups">Database Backups</h4>

<p>Backing up Builder&rsquo;s PostgreSQL database is the same as for any PostgreSQL database. The process is a <a href="https://www.postgresql.org/docs/11/app-pgdump.html">pg_dump</a>. If you have a backup strategy for other production instances of PostgreSQL, then apply your backup pattern to the <code>builder</code> database. To backup your <code>builder</code> database manually, follow these steps:</p>

<ol>
<li>Shut down the API to ensure no active transactions are occuring. (Optional but preferred)
    <code>hab svc stop habitat/builder-api</code></li>
<li>Switch to user <code>hab</code>
    <code>sudo su - hab</code></li>
<li>Find your Postgres password
    <code>sudo cat /hab/svc/builder-api/config/config.toml</code></li>
<li>Export as envvar
    <code>export PGPASSWORD=&lt;pw&gt;</code></li>
<li>Run pgdump
    <code>/hab/pkgs/core/postgresql/&lt;version&gt;/&lt;release&gt;/bin/pg_dump --file=builder.dump --format=custom --host=&lt;ip_of_pg_host&gt; --dbname=builder</code></li>
<li>Start the api and verify
    <code>sudo hab svc start habitat/builder-api</code></li>
</ol>

<p>Once the backup finishes,  your will find it as the <code>builder.dump</code> file on your filesystem. Move and store this file according to your local policies. We recommend storing it remotely&ndash;either physically or virtually&ndash;so it will be useable in a worst-case scenario. For most, storing the dump file in an AWS bucket or Azure storage is enough, but you should follow the same strategy for all database backups.</p>

<h4 id="database-restore">Database Restore</h4>

<p>Restoring a <code>builder</code> database is exactly like restoring any other database&ndash;which is to say, there is no magical solution. If you already have a restoration strategy in place at your organization, follow that to restore your <code>builder</code> database.  To restore your  data <code>builder</code> database manually, follow these steps:</p>

<ol>
<li>Switch to user <code>hab</code>
    <code>sudo su - hab</code></li>
<li>Find your Postgres password
    <code>sudo cat /hab/svc/builder-api/config/config.toml</code></li>
<li>Export as envvar
    <code>export PGPASSWORD=&lt;pw&gt;</code></li>
<li>Create the new builder database *
    <code>/hab/pkgs/core/postgresql/&lt;version&gt;/&lt;release&gt;/bin/createdb -w -h &lt;url_of_pg_host&gt; -p &lt;configured_pg_port&gt; -U hab builder</code></li>
<li>Verify connectivity to the new database instance
    <code>/hab/pkgs/core/postgresql/&lt;version&gt;/&lt;release&gt;/bin/psql --host=&lt;url_of_pg_host&gt; --dbname=builder</code></li>
<li>Restore the dump into the new DB
    <code>/hab/pkgs/core/postgresql/&lt;version&gt;/&lt;release&gt;/bin/pg_restore --host=&lt;url_of_pg_host&gt; --dbname=builder builder.dump</code></li>

<li><p>Start the on-prem Builder services</p>

<pre><code>* In some cases your version of Postgres might not have a createdb binary in which case you'll want to connect to database to run the create db command
</code></pre></li>
</ol>

<p>Just like that your database data should be restored and ready for new transactions!</p>

<h4 id="artifact-backups">Artifact Backups</h4>

<p>The process of artifact backups is quite a bit more environmentally subjective than Postgres if only because we support more than one artifact storage backend. For the sake of these docs we will focus on Minio backups.</p>

<p>Backing up Minio is also a bit subjective but more or less amounts to a filesystem backup. Because Minio stores its files on the filesystem  (unless you&rsquo;re using a non-standard configuration) any filesystem backup strategy you want to use should be fine whether thats disk snapshotting of some kind or data  mirroring, and rsync. Minio however also has the <a href="https://docs.min.io/docs/minio-client-quickstart-guide.html">minio client</a> which provides a whole boatload of useful features and specifically allows the user to mirror a bucket to an alternative location on the filesystem or even a remote S3 bucket! Ideally you should <em>never</em> directly/manually manipulate the files within Minio&rsquo;s buckets while it could be performing IO. Which means you should <em>always</em> use the Minio client mentioned above to manipulate Minio data.</p>

<p>A simple backup strategy might look like this:
1. Shut down the API to ensure no active transactions are occuring. (Optional but preferred)
        <code>hab svc stop habitat/builder-api</code>
1. Mirror Minio data to an AWS S3 bucket. **
        <code>mc mirror &lt;local/minio/object/dir&gt; &lt;AWS_/S3_bucket&gt;</code>
** Another option here is to mirror to a different part of the filesystem, perhaps one that&rsquo;s NFS mounted or the like and then snapshotting it:
        `mc mirror <local/minio/object/dir> <new/local/path></p>

<p>As mentioned before since this operation could be dramatically different for different environments Minio backup cannot be 100% prescriptive. But This should give you some ideas to explore.</p>

<p>What&rsquo;s more, in the case that you&rsquo;re using Artifactory as the artifact store we would highly recommend reading <a href="https://jfrog.com/whitepaper/best-practices-for-artifactory-backups-and-disaster-recovery/">Artifactory&rsquo;s thoughts on back-ups</a></p>

<h2 id="support">Support</h2>

<p>You can also post any questions or issues on the <a href="https://forums.habitat.sh/">Habitat Forum</a>, on our <a href="https://habitat-sh.slack.com">Slack channel</a>, or file issues directly at the <a href="https://github.com/habitat-sh/on-prem-builder/issues">Github repo</a>.</p>

<h2 id="troubleshooting">Troubleshooting</h2>

<h3 id="network-access-proxy-configuration">Network access / proxy configuration</h3>

<p>If the initial install fails, please check that you have outgoing connectivity, and that you can successfully ping the following:</p>

<ul>
<li><code>raw.githubusercontent.com</code></li>
<li><code>bldr.habitat.sh</code></li>
</ul>

<p>If you have outgoing access via a proxy, please ensure that HTTPS_PROXY is set correctly in your environment.</p>

<p>You also will need to have the following <em>inbound</em> port open for your instance:</p>

<ul>
<li>Port 80</li>
</ul>

<p>In the case that you have configured your proxy for the local session while installing but are still receiving connection refusal errors like the one below, you may want to configure your proxy with the <code>/etc/environment</code> file or similar.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-output" data-lang="output"><span style="color:#666">--</span> Logs begin at Mon <span style="color:#666">2019</span><span style="color:#666">-</span><span style="color:#666">06</span><span style="color:#666">-</span><span style="color:#666">10</span> <span style="color:#666">09</span>:<span style="color:#666">02</span>:<span style="color:#666">13</span> PDT. <span style="color:#666">--</span>
Jun <span style="color:#666">10</span> <span style="color:#666">09</span>:<span style="color:#666">35</span>:<span style="color:#666">15</span> &lt;TargetMachine&gt; hab[<span style="color:#666">13161</span>]: <span style="">∵</span> Missing <span style="color:#a2f;font-weight:bold">package</span> <span style="color:#a2f;font-weight:bold">for</span> core<span style="color:#666">/</span>hab<span style="color:#666">-</span>launcher
Jun <span style="color:#666">10</span> <span style="color:#666">09</span>:<span style="color:#666">35</span>:<span style="color:#666">15</span> &lt;TargetMachine&gt; hab[<span style="color:#666">13161</span>]: <span style="">»</span> Installing core<span style="color:#666">/</span>hab<span style="color:#666">-</span>launcher
Jun <span style="color:#666">10</span> <span style="color:#666">09</span>:<span style="color:#666">35</span>:<span style="color:#666">15</span> &lt;TargetMachine&gt; hab[<span style="color:#666">13161</span>]: <span style="">☁</span> Determining latest version of core<span style="color:#666">/</span>hab<span style="color:#666">-</span>launcher in the <span style="">&#39;</span>stable<span style="">&#39;</span> channel
Jun <span style="color:#666">10</span> <span style="color:#666">09</span>:<span style="color:#666">35</span>:<span style="color:#666">15</span> &lt;TargetMachine&gt; hab[<span style="color:#666">13161</span>]: <span style="">✗✗✗</span>
Jun <span style="color:#666">10</span> <span style="color:#666">09</span>:<span style="color:#666">35</span>:<span style="color:#666">15</span> &lt;TargetMachine&gt; hab[<span style="color:#666">13161</span>]: <span style="">✗✗✗</span> Connection <span style="color:#00a000">refused</span> (os <span style="color:#0b0;font-weight:bold">error</span> <span style="color:#666">111</span>)
Jun <span style="color:#666">10</span> <span style="color:#666">09</span>:<span style="color:#666">35</span>:<span style="color:#666">15</span> &lt;TargetMachine&gt; hab[<span style="color:#666">13161</span>]: <span style="">✗✗✗</span>
Jun <span style="color:#666">10</span> <span style="color:#666">09</span>:<span style="color:#666">35</span>:<span style="color:#666">15</span> &lt;TargetMachine&gt; systemd[<span style="color:#666">1</span>]: hab<span style="color:#666">-</span>sup.service: Main process exited, code=exited, status=<span style="color:#666">1</span><span style="color:#666">/</span>FAILURE
Jun <span style="color:#666">10</span> <span style="color:#666">09</span>:<span style="color:#666">35</span>:<span style="color:#666">15</span> &lt;TargetMachine&gt; hab[<span style="color:#666">13171</span>]: Supervisor not started.
Jun <span style="color:#666">10</span> <span style="color:#666">09</span>:<span style="color:#666">35</span>:<span style="color:#666">15</span> &lt;TargetMachine&gt; systemd[<span style="color:#666">1</span>]: hab<span style="color:#666">-</span>sup.service: Unit entered failed state.
Jun <span style="color:#666">10</span> <span style="color:#666">09</span>:<span style="color:#666">35</span>:<span style="color:#666">15</span> &lt;TargetMachine&gt; systemd[<span style="color:#666">1</span>]: hab<span style="color:#666">-</span>sup.service: Failed with result <span style="">&#39;</span>exit<span style="color:#666">-</span>code<span style="">&#39;</span></code></pre></div>
<p>Please work with your enterprise network admin to ensure the appropriate firewall rules are configured for network access.</p>

<h3 id="authentication-failure-when-logging-in">Authentication failure when logging in</h3>

<p>If you are not able to log in, please double check the settings that you have configured your OAuth application with, as well as the URLs that you have specified in your <code>bldr.env</code> file.</p>

<h3 id="unable-to-retrieve-oauth-token">Unable to retrieve OAuth token</h3>

<p>You were able to sign in to the authentication provider, but unable to authenticate with Chef Habitat&rsquo;s OAuth token.</p>

<p>Open the <code>bldr.env</code> and verify that:
* <strong>APP_URL</strong> ends with &ldquo;/\&rdquo;
* <strong>OAUTH_REDIRECT_URL</strong> ends with &ldquo;/\&rdquo;
* <strong>OAUTH_CLIENT_ID</strong> is complete and correct
* <strong>OAUTH_CLIENT_SECRET</strong> is complete and correct</p>

<p>Apply changes to the <code>bldr.env</code> by running the install script:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">bash ./install.sh</code></pre></div>
<p>Restart the Chef Habitat services:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo systemctl restart hab-sup</code></pre></div>
<h3 id="self-signed-cert-files-do-not-exist">Self-signed cert files do not exist</h3>

<p>The latest version of the Chef Habitat Builder on-prem services looks certificates in the <code>/hab/cache/ssl</code> directory. Copy your self-signed certificates directory if they are missing. Follow the naming pattern <code>appname-cert.cert</code> or <code>appname-cert.pem</code>, for example <code>automate-cert.cert</code> or <code>automate-cert.pem</code>. Do not use <code>cert.pem</code>, which is reserved for the Chef Habitat system. Overwriting this file will cause Chef Habitat Builder to fail.</p>

<p>Restart the Chef Habitat services:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo systemctl restart hab-sup</code></pre></div>
<h3 id="error-sorry-too-many-clients-already">Error &ldquo;sorry, too many clients already&rdquo;</h3>

<p>If the hab services don&rsquo;t come up as expected, use <code>journalctl -fu hab-sup</code> to check the service logs (also see below for turning on Debug Logging).</p>

<p>If you see a Postgresql error &ldquo;sorry, too many clients already&rdquo;, you may need to increase the number of configured connections to the database.</p>

<p>In order to do that, run the following:</p>

<p><code>echo 'max_connections=200' | hab config apply &quot;builder-datastore.default&quot; $(date +%s)</code></p>

<p>Wait for a bit for the datastore service to restart. If the service does not restart on it&rsquo;s own, you can do a &lsquo;sudo systemctl restart hab-sup&rsquo; to restart things.</p>

<h3 id="error-too-many-open-files">Error &ldquo;Too many open files&rdquo;</h3>

<p>If you see this error message in the supervisor logs, that may indicate that you need to increase the file ulimit on your system. The Chef Habitat Builder on-prem systemd configuration includes an expanded file limit, however some distributions (eg, on CentOS 7) may require additional system configuration.</p>

<p>For example, add the following to the end of your <code>/etc/security/limits.conf</code> file, and restart your system.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">* soft nofile 65535
* hard nofile 65535</code></pre></div>
<h3 id="error-text-file-busy">Error &ldquo;Text file busy&rdquo;</h3>

<p>Occasionally you may get an error saying &ldquo;Text file too busy&rdquo; during install.
If you get this, please re-try the install step again.</p>

<h3 id="error-when-bootstrapping-core-packages">Error when bootstrapping core packages</h3>

<p>You may see the following error when bootstrapping the core packages using the script above. If this happens, the bootstrap process will continue re-trying, and the upload will eventually succeed. Be patient and let the process continue until successful completion.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-output" data-lang="output">✗✗✗
✗✗✗ Pooled stream disconnected
✗✗✗</code></pre></div>
<p>If some packages do not upload, you may try re-uploading them manually via the <code>hab pkg upload</code> command.</p>

<p>This may also be an indication that your installation may not have sufficient CPU, RAM or other resources, and you may want to either allocate additional resources (eg, if on a VM) or move to a more scaled-up instance.</p>

<h3 id="error-uploading-large-packages">Error uploading large packages</h3>

<p>By default, the installed services configuration will set a 2GB limit for packages that can be uploaded to the Chef Habitat Builder on-prem. If you need to change the limit, you can do so by injecting an updated config to the Chef Habitat Builder on-prem services.</p>

<p>For example, to change the limit to 3GB, you could do the following:</p>

<p>Create a file called <code>config.toml</code> with the following content:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-toml" data-lang="toml">[nginx]
max_body_size = <span style="color:#b44">&#34;3072m&#34;</span>
proxy_send_timeout = <span style="color:#666">360</span>
proxy_read_timeout = <span style="color:#666">360</span>

[http]
keepalive_timeout = <span style="color:#b44">&#34;360s&#34;</span></code></pre></div>
<p>Then, issue the following command:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">hab config apply builder-api-proxy.default <span style="color:#a2f;font-weight:bold">$(</span>date +%s<span style="color:#a2f;font-weight:bold">)</span> config.toml</code></pre></div>
<p>After the config is successfully applied, re-try the upload.</p>

<p>If you have any issues, you may also need to adjust the timeout configuration on the Chef Habitat client.
You can do that via an environment variable: <code>HAB_CLIENT_SOCKET_TIMEOUT</code>. The value of this environment variable is a timeout in seconds. So for example, you could do something like this when uploading a file:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#b8860b">HAB_CLIENT_SOCKET_TIMEOUT</span><span style="color:#666">=</span><span style="color:#666">360</span> hab pkg upload -u http://localhost -z &lt;your auth token&gt; &lt;file&gt;</code></pre></div>
<h3 id="package-shows-up-in-the-ui-and-hab-pkg-search-but-hab-pkg-install-fails">Package shows up in the UI and <code>hab pkg search</code>, but <code>hab pkg install</code> fails</h3>

<p>If you run into a situation where you have a package populated in the Chef Habitat Builder on-prem, but it is failing to install with a <code>Not Found</code> status, it is possible that there was a prior problem with populating the Minio backend with the package artifact.</p>

<p>If you have the package artifact on-disk (for example, in the <code>hab/cache/artifacts</code> directory), you can try to upload the missing package again with the following command (update the parameters as appropriate):</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">hab pkg upload -u http://localhost -z &lt;your auth token&gt; --force &lt;package hart file&gt;</code></pre></div>
<p>Note: the &ndash;force option above is only available in versions of the <code>hab</code> client greater than 0.59.</p>

<h3 id="on-prem-archive-sh-fails-during-populate-depot-with-403-error-during-core-package-uploads">on-prem-archive.sh Fails during <code>populate-depot</code> with <code>403</code> error during core package uploads</h3>

<p>When populating your Chef Habitat Builder on-prem with upstream core packages, you may run into an error that looks like this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-output" data-lang="output">Uploading hart files.

[1/958] Uploading ./core-img-0.5.4-20190201011741-x86_64-linux.hart to the depot at https://your.awesome.depot
  75 B / 75 B | [=========================================] 100.00 % 384 B/s
✗✗✗
✗✗✗ [403 Forbidden]
✗✗✗</code></pre></div>
<p>And repeats for every package. Check to make sure you&rsquo;ve created the <code>core</code> origin and then try again, if you haven&rsquo;t, then the upload will fail.</p>

<h2 id="logs">Logs</h2>

<h3 id="log-rotation">Log Rotation</h3>

<p>The <code>builder-api-proxy</code> service will log (via Nginx) all access and errors to log files in your service directory. Since these files may get large, you may want to add a log rotation script. Below is a sample logrotate file that you can use as an example for your needs:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/hab/svc/builder-api-proxy/logs/host.access.log
/hab/svc/builder-api-proxy/logs/host.error.log
<span style="color:#666">{</span>
        rotate <span style="color:#666">7</span>
        daily
        missingok
        notifempty
        delaycompress
        compress
        postrotate
                /bin/kill -USR1 <span style="color:#b44">`</span>cat /hab/svc/builder-api-proxy/var/pid <span style="color:#666">2</span>&gt;/dev/null<span style="color:#b44">`</span> <span style="color:#666">2</span>&gt;/dev/null <span style="color:#666">||</span> <span style="color:#a2f">true</span>
        endscript
<span style="color:#666">}</span></code></pre></div>
<h3 id="debug-logging">Debug Logging</h3>

<p>If you want to turn on and examine the services debug logging, you can do so by doing the following on your install location:</p>

<p>Edit the <code>/hab/svc/builder-api/user.toml</code> file and update the <code>log_level</code> entry to start with <code>debug</code></p>

<p>After making the edit, restart the hab services with <code>sudo systemctl restart hab-sup</code>, or just stop and start the builder-api service with <code>hab svc stop habitat/builder-api</code> and <code>hab svc start habitat/builder-api</code>.</p>

<p>Once the logging is enabled, you can examine it via <code>journalctl -fu hab-sup</code></p>

<p>When you are done with debugging, you can set the logging back to the default setting by modifying the user.toml and restarting the services.</p>

<h2 id="license">License</h2>

<p>Copyright &copy; 2018 Chef Software Inc. and/or applicable contributors</p>

<p>Licensed under the Apache License, Version 2.0 (the &ldquo;License&rdquo;); you may not use this file except in compliance with the License. You may obtain a copy of the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a> at <code>http://www.apache.org/licenses/LICENSE-2.0)</code>
Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an &ldquo;AS IS&rdquo; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.</p>

<h2 id="support-1">Support</h2>

<p>You can also post any questions or issues on the <a href="https://forums.habitat.sh/">Habitat Forum</a>, on our <a href="https://habitat-sh.slack.com">Slack channel</a>, or file issues directly at the <a href="https://github.com/habitat-sh/on-prem-builder/issues">Github repo</a>.</p>

</div>

            </div>
          </div>
        </div>
      </div>
      <div id="footer" class="cell small-12">
        <div class="grid-x">
          <div class="cell small-12">
            <nav>
              
<footer>
  <div class="grid-container">
    <div class="grid-x align-middle">
      <div class="cell small-12 large-3 logo"><a href="/"><img src="/images/chef-logo-light.svg" alt="Chef Habitat Builder on-prem documentation"></a></div>
      <div class="cell small-12 large-9">
        <ul class="menu vertical medium-horizontal">
          <li><a href="https://www.chef.io/online-master-agreement/" target="_blank">Licensing</a></li>
          <li><a href="https://www.chef.io/terms-of-service/" target="_blank">Terms &amp; Conditions</a></li>
          <li><a href="https://www.chef.io/trademark-policy/" target="_blank">Trademark Policy</a></li>
          <li><a href="https://www.chef.io/privacy-policy/" target="_blank">Privacy Policy</a></li>
          <li><a href="https://www.chef.io/cookie-policy/" target="_blank">Cookie Policy</a></li>
        </ul>
        <p class="legal">&copy; 2008-2019 Chef Software, Inc. All Rights Reserved.</p>
      </div>
    </div>
  </div>
</footer>

            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="/js/scripts-all.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
  <script type="text/javascript">
    docsearch({
      apiKey: '3f16191e15b2b4a4b0823c9f856e2de2',
      indexName: 'chef_sh',
      inputSelector: '#doc-search',
      debug: false 
    });
  </script>
</body>
</html>
